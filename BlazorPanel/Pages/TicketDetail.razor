@page "/ticket/{Id:int}"
@inject TicketService TicketService
@inject NavigationManager Navigation
@using TicketSystem.Blazor.Models

<PageTitle>Detalle del Ticket</PageTitle>

<div class="mb-4">
    <button class="btn btn-secondary" @onclick="Volver">← Volver al listado</button>
</div>

@if (ticket == null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Ticket #@ticket.Id</h2>
        <span class="badge @GetBadgeClass(ticket.Estado)" style="font-size: 1rem;">@ticket.Estado</span>
    </div>

    <div class="row" style="display: flex; gap: 2rem;">
        <div style="flex: 2;">
            <div class="card-elegant">
                <div class="card-header">Información Principal</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="d-block mb-1 font-weight-bold text-muted small">TÍTULO</label>
                        <input type="text" class="form-control" @bind="ticket.Titulo" />
                    </div>

                    <div class="mb-3">
                        <label class="d-block mb-1 font-weight-bold text-muted small">DESCRIPCIÓN</label>
                        <textarea class="form-control" rows="5" @bind="ticket.Descripcion"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div style="flex: 1;">
            <div class="card-elegant">
                <div class="card-header">Meta Información</div>
                <div class="card-body">
                     <div class="mb-3">
                        <label class="d-block mb-1 font-weight-bold text-muted small">CLIENTE</label>
                        <input type="text" class="form-control" @bind="ticket.ClienteNombre" readonly style="background-color: #f1f5f9;" />
                    </div>

                    <div class="mb-3">
                        <label class="d-block mb-1 font-weight-bold text-muted small">ESTADO</label>
                        <select class="form-control" @bind="ticket.Estado">
                            <option value="Abierto">Abierto</option>
                            <option value="EnProceso">En Proceso</option>
                            <option value="Cerrado">Cerrado</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="d-block mb-1 font-weight-bold text-muted small">PRIORIDAD</label>
                        <select class="form-control" @bind="ticket.Prioridad">
                            <option value="Baja">Baja</option>
                            <option value="Media">Media</option>
                            <option value="Alta">Alta</option>
                        </select>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1.5rem 0;" />

                    <button class="btn btn-primary" style="width: 100%; justify-content: center;" @onclick="GuardarCambios">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Ticket? ticket;

    protected override async Task OnInitializedAsync()
    {
        ticket = await TicketService.GetTicketByIdAsync(Id);
    }

    private async Task GuardarCambios()
    {
        if (ticket != null)
        {
            await TicketService.UpdateTicketAsync(Id, ticket);
            Navigation.NavigateTo("/");
        }
    }

    private void Volver()
    {
        Navigation.NavigateTo("/");
    }

     private string GetBadgeClass(string estado) => estado switch
    {
        "Abierto" => "badge-open",
        "EnProceso" => "badge-process",
        "Cerrado" => "badge-closed",
        _ => "badge-secondary"
    };
}
